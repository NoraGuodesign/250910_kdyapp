<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>肯定语应用</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#F5F7FA',
                        accent: '#FF7D00',
                        dark: '#1D2129',
                        light: '#FFFFFF',
                        'gray-light': '#C9CDD4',
                        'gray-medium': '#86909C',
                        'gray-dark': '#4E5969'
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .text-shadow {
                text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
            .message-bubble-right {
                border-radius: 18px 18px 4px 18px;
            }
            .message-bubble-left {
                border-radius: 18px 18px 18px 4px;
            }
            .sticker-active {
                @apply bg-primary/10;
            }
        }
    </style>
</head>

<body class="bg-secondary min-h-screen font-sans text-dark">
    <!-- 顶部导航栏 -->
    <header class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur z-50 border-b border-gray-light/20">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-[18px] font-semibold text-primary">肯定语</h1>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="text-gray-dark hover:text-primary transition-colors">
                    <i class="fa fa-moon-o text-lg"></i>
                </button>
                <button id="settings-btn" class="text-gray-dark hover:text-primary transition-colors">
                    <i class="fa fa-cog text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-16 pb-24">
        <!-- 功能标签切换器 -->
        <div class="flex border-b border-gray-light/30 mb-6 overflow-x-auto scrollbar-hide">
            <button class="tab-btn active flex-1 py-3 px-4 text-primary font-medium border-b-2 border-primary transition-all" data-tab="affirmation-generator">
                肯定语生成
            </button>
            <button class="tab-btn flex-1 py-3 px-4 text-gray-medium font-medium hover:text-gray-dark transition-all" data-tab="affirmation-chat">
                A肯定语区域
            </button>
            <button class="tab-btn flex-1 py-3 px-4 text-gray-medium font-medium hover:text-gray-dark transition-all" data-tab="daily-affirmation">
                睡前肯定
            </button>
        </div>

        <!-- 1. 肯定语生成模块 -->
        <section id="affirmation-generator" class="tab-content block">
            <div class="bg-white rounded-xl shadow-sm p-5 mb-6 transform transition-all duration-300 hover:shadow-md">
                <h2 class="text-xl font-semibold mb-4">生成肯定语</h2>
                
                <div class="mb-4">
                    <label for="affirmation-topic" class="block text-gray-dark mb-2 text-sm">你想要肯定的主题是：</label>
                    <input 
                        type="text" 
                        id="affirmation-topic" 
                        class="w-full px-4 py-3 rounded-lg border border-gray-light focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all"
                        placeholder="例如：健康、财富、爱情..."
                    >
                </div>
                
                <button id="generate-affirmation" class="w-full bg-primary text-white py-3 px-4 rounded-lg font-medium hover:bg-primary/90 active:bg-primary/80 transition-all flex items-center justify-center gap-2">
                    <span>生成肯定语</span>
                    <i class="fa fa-magic"></i>
                </button>
            </div>
            
            <!-- 生成结果区域 -->
            <div id="affirmation-result" class="bg-white rounded-xl shadow-sm p-5 transform transition-all duration-300 hover:shadow-md hidden">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-medium text-gray-dark">生成的肯定语：</h3>
                    <button id="share-affirmations" class="text-primary text-sm hover:text-primary/80 transition-colors flex items-center gap-1">
                        <i class="fa fa-share-alt"></i>
                        <span>分享</span>
                    </button>
                </div>
                <div id="affirmation-output" class="space-y-2 text-gray-dark">
                    <!-- 生成的肯定语将在这里显示 -->
                </div>
            </div>
        </section>

        <!-- 2. A肯定语区域（聊天界面） -->
        <section id="affirmation-chat" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm h-[500px] flex flex-col transform transition-all duration-300 hover:shadow-md overflow-hidden">
                <!-- 聊天头部 -->
                <div class="border-b border-gray-light/30 p-4 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">A肯定语</h2>
                    <div class="flex gap-3">
                        <button id="clear-chat" class="text-gray-dark hover:text-primary transition-colors">
                            <i class="fa fa-trash-o"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 聊天内容区和表情包区容器 -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <!-- 聊天内容区 -->
                    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto scrollbar-hide space-y-4">
                        <!-- 消息会在这里显示 -->
                        <div class="text-center text-gray-medium text-sm py-4">
                            开始你的肯定语交流吧
                        </div>
                    </div>
                    
                    <!-- 表情包切换栏 -->
                    <div class="border-t border-gray-light/30 p-2 flex items-center justify-between bg-white">
                        <button id="toggle-stickers" class="text-gray-dark hover:text-primary transition-colors p-2 rounded-full hover:bg-secondary">
                            <i class="fa fa-smile-o text-xl"></i>
                        </button>
                        <div class="flex-1"></div>
                        <label for="sticker-upload" class="text-primary hover:text-primary/80 transition-colors p-2 rounded-full hover:bg-secondary cursor-pointer">
                            <i class="fa fa-plus text-lg"></i>
                        </label>
                        <input type="file" id="sticker-upload" accept="image/*" class="hidden">
                    </div>
                    
                    <!-- 表情包库（默认隐藏，与聊天界面整合） -->
                    <div id="sticker-library" class="h-0 border-t border-gray-light/30 bg-white overflow-hidden transition-all duration-300">
                        <div class="p-2">
                            <div id="sticker-grid" class="grid grid-cols-4 gap-2 overflow-y-auto scrollbar-hide h-full">
                                <!-- 表情包会在这里显示 -->
                                <div class="text-center text-gray-medium text-sm py-8 col-span-4">
                                    还没有表情包，点击"+"添加
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. 睡前肯定的五件小事 -->
        <section id="daily-affirmation" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm p-5 mb-6 transform transition-all duration-300 hover:shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">睡前肯定的五件小事</h2>
                    <span id="current-date" class="text-sm text-gray-medium"></span>
                </div>
                
                <p class="text-gray-dark text-sm mb-4">记录今天发生的至少五件成功的小事，这会帮助你培养积极心态</p>
                
                <div id="success-items">
                    <div class="success-item mb-3 flex gap-2">
                        <span class="bg-secondary rounded-full w-6 h-6 flex items-center justify-center text-gray-medium flex-shrink-0">1</span>
                        <input type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-light focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all" placeholder="今天的第一件成功小事...">
                    </div>
                    <div class="success-item mb-3 flex gap-2">
                        <span class="bg-secondary rounded-full w-6 h-6 flex items-center justify-center text-gray-medium flex-shrink-0">2</span>
                        <input type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-light focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all" placeholder="今天的第二件成功小事...">
                    </div>
                    <div class="success-item mb-3 flex gap-2">
                        <span class="bg-secondary rounded-full w-6 h-6 flex items-center justify-center text-gray-medium flex-shrink-0">3</span>
                        <input type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-light focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all" placeholder="今天的第三件成功小事...">
                    </div>
                    <div class="success-item mb-3 flex gap-2">
                        <span class="bg-secondary rounded-full w-6 h-6 flex items-center justify-center text-gray-medium flex-shrink-0">4</span>
                        <input type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-light focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all" placeholder="今天的第四件成功小事...">
                    </div>
                    <div class="success-item mb-3 flex gap-2">
                        <span class="bg-secondary rounded-full w-6 h-6 flex items-center justify-center text-gray-medium flex-shrink-0">5</span>
                        <input type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-light focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all" placeholder="今天的第五件成功小事...">
                    </div>
                </div>
                
                <button id="add-more-item" class="w-full text-primary text-sm py-2 hover:text-primary/80 transition-colors flex items-center justify-center gap-1 mb-4">
                    <i class="fa fa-plus-circle"></i>
                    <span>添加更多</span>
                </button>
                
                <button id="save-daily-items" class="w-full bg-primary text-white py-3 px-4 rounded-lg font-medium hover:bg-primary/90 active:bg-primary/80 transition-all flex items-center justify-center gap-2 mb-3">
                    <span>保存今日小事</span>
                    <i class="fa fa-save"></i>
                </button>
                
                <button id="generate-daily-comment" class="w-full bg-white text-primary border border-primary py-3 px-4 rounded-lg font-medium hover:bg-primary/5 active:bg-primary/10 transition-all flex items-center justify-center gap-2">
                    <span>获取AI鼓励</span>
                    <i class="fa fa-comment-o"></i>
                </button>
            </div>
            
            <!-- AI评论区域 -->
            <div id="daily-comment" class="bg-white rounded-xl shadow-sm p-5 transform transition-all duration-300 hover:shadow-md hidden">
                <div class="flex items-start gap-3">
                    <div class="bg-primary/10 text-primary rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0 mt-1">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-medium mb-2 text-gray-dark">AI的鼓励：</h3>
                        <p id="ai-comment-content" class="text-gray-dark">
                            <!-- AI评论将在这里显示 -->
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- 历史记录 -->
            <div class="bg-white rounded-xl shadow-sm p-5 transform transition-all duration-300 hover:shadow-md">
                <h3 class="text-lg font-semibold mb-3">历史记录</h3>
                <div id="history-list" class="space-y-3 max-h-[200px] overflow-y-auto scrollbar-hide">
                    <!-- 历史记录会在这里显示 -->
                    <div class="text-center text-gray-medium text-sm py-4">
                        暂无记录
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 底部导航 -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-light/20 z-40">
        <div class="container mx-auto">
            <div class="flex justify-around">
                <button class="tab-nav-btn active flex flex-col items-center justify-center py-3 px-4 text-primary" data-tab="affirmation-generator">
                    <i class="fa fa-magic text-lg mb-1"></i>
                    <span class="text-xs">生成</span>
                </button>
                <button class="tab-nav-btn flex flex-col items-center justify-center py-3 px-4 text-gray-medium" data-tab="affirmation-chat">
                    <i class="fa fa-comments-o text-lg mb-1"></i>
                    <span class="text-xs">聊天</span>
                </button>
                <button class="tab-nav-btn flex flex-col items-center justify-center py-3 px-4 text-gray-medium" data-tab="daily-affirmation">
                    <i class="fa fa-bed text-lg mb-1"></i>
                    <span class="text-xs">睡前</span>
                </button>
            </div>
        </div>
    </footer>

    <!-- 通知提示 -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-dark text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300 flex items-center gap-2">
        <i class="fa fa-info-circle"></i>
        <span id="toast-message"></span>
    </div>

    <!-- 表情包删除确认框 -->
    <div id="delete-confirm" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-xs p-5">
            <h3 class="text-lg font-semibold mb-2 text-center">删除表情包</h3>
            <p class="text-gray-dark text-center mb-4">确定要删除这个表情包吗？</p>
            <div class="flex gap-3">
                <button id="cancel-delete" class="flex-1 bg-white text-gray-dark border border-gray-light py-2 px-4 rounded-lg font-medium hover:bg-gray-light/10 transition-all">
                    取消
                </button>
                <button id="confirm-delete" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-600 transition-all">
                    删除
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let stickerToDelete = null;
        let stickersVisible = false;
        const API_KEY = '14962cd4c48f430b89f2986be05dc3d4.zK4DNXWm84Hk9jCI';
        const MODEL = 'glm-4';
        
        // DOM 元素加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前日期
            const dateElement = document.getElementById('current-date');
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            dateElement.textContent = today.toLocaleDateString('zh-CN', options);
            
            // 加载历史记录
            loadHistory();
            
            // 加载表情包
            loadStickers();
            
            // 标签切换功能
            const tabBtns = document.querySelectorAll('.tab-btn, .tab-nav-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // 更新按钮状态
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.classList.remove('active', 'text-primary', 'border-primary', 'border-b-2');
                        b.classList.add('text-gray-medium');
                    });
                    document.querySelectorAll('.tab-nav-btn').forEach(b => {
                        b.classList.remove('active', 'text-primary');
                        b.classList.add('text-gray-medium');
                    });
                    
                    this.classList.add('active', 'text-primary');
                    if (this.classList.contains('tab-btn')) {
                        this.classList.add('border-primary', 'border-b-2');
                    }
                    
                    // 显示对应的内容
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(tabId).classList.remove('hidden');
                });
            });
            
            // 1. 肯定语生成功能
            document.getElementById('generate-affirmation').addEventListener('click', generateAffirmations);
            document.getElementById('share-affirmations').addEventListener('click', shareAffirmations);
            
            // 2. 表情包功能
            document.getElementById('sticker-upload').addEventListener('change', handleStickerUpload);
            document.getElementById('toggle-stickers').addEventListener('click', toggleStickers);
            document.getElementById('cancel-delete').addEventListener('click', cancelDeleteSticker);
            document.getElementById('confirm-delete').addEventListener('click', confirmDeleteSticker);
            document.getElementById('clear-chat').addEventListener('click', clearChat);
            
            // 3. 睡前肯定功能
            document.getElementById('add-more-item').addEventListener('click', addMoreItem);
            document.getElementById('save-daily-items').addEventListener('click', saveDailyItems);
            document.getElementById('generate-daily-comment').addEventListener('click', generateDailyComment);
        });
        
        // 1. 肯定语生成相关函数
        async function generateAffirmations() {
            const topicInput = document.getElementById('affirmation-topic');
            const topic = topicInput.value.trim();
            
            if (!topic) {
                showToast('请输入肯定的主题');
                return;
            }
            
            // 显示加载状态
            const generateBtn = document.getElementById('generate-affirmation');
            const originalText = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 生成中...';
            
            try {
                // 实际项目中这里应该调用API
                const prompt = `帮我写类似下面这样的肯定语，主题换成${topic}，肯定语参照如下：
                我经常无缘无故收到钱
                我有很多钱
                我总是有很多钱
                钱和我的关系很好
                钱从四面八方来
                钱从四面八方向我涌来
                我的钱多到花不完`;
                
                // 模拟API调用延迟
                setTimeout(() => {
                    // 模拟生成的结果
                    const mockResults = [
                        `我总是能感受到${topic}`,
                        `${topic}一直伴随着我`,
                        `我值得拥有${topic}`,
                        `${topic}从各个方面向我走来`,
                        `我与${topic}有着深厚的联系`,
                        `我每天都在体验${topic}`,
                        `${topic}在我的生活中无处不在`
                    ];
                    
                    displayAffirmations(mockResults);
                    
                    // 恢复按钮状态
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = originalText;
                }, 1000);
            } catch (error) {
                console.error('生成肯定语失败:', error);
                showToast('生成肯定语失败，请重试');
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            }
        }
        
        function displayAffirmations(affirmations) {
            const outputElement = document.getElementById('affirmation-output');
            const resultContainer = document.getElementById('affirmation-result');
            
            outputElement.innerHTML = '';
            
            affirmations.forEach((affirmation, index) => {
                if (affirmation.trim()) {
                    const p = document.createElement('p');
                    p.className = 'py-2 px-3 bg-secondary rounded-lg flex items-start gap-2';
                    p.innerHTML = `
                        <span class="text-primary font-medium">${index + 1}.</span>
                        <span>${affirmation.trim()}</span>
                    `;
                    outputElement.appendChild(p);
                }
            });
            
            resultContainer.classList.remove('hidden');
            
            // 平滑滚动到结果区域
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function shareAffirmations() {
            const outputElement = document.getElementById('affirmation-output');
            const texts = Array.from(outputElement.querySelectorAll('p span:last-child'))
                .map(span => span.textContent);
            
            const textToShare = texts.join('\n\n');
            
            // 检查浏览器是否支持分享API
            if (navigator.share) {
                navigator.share({
                    title: '我的肯定语',
                    text: textToShare
                }).catch(err => {
                    console.error('分享失败:', err);
                    showToast('分享取消或失败');
                });
            } else {
                // 不支持分享API时，复制到剪贴板
                navigator.clipboard.writeText(textToShare).then(() => {
                    showToast('肯定语已复制，可以粘贴分享');
                }).catch(err => {
                    console.error('复制失败:', err);
                    showToast('复制失败，请手动复制');
                });
            }
        }
        
        // 2. 表情包相关函数
        function handleStickerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const stickerUrl = e.target.result;
                
                // 保存到本地存储
                let stickers = JSON.parse(localStorage.getItem('stickers') || '[]');
                stickers.push({
                    id: Date.now(),
                    url: stickerUrl,
                    added: new Date().toISOString()
                });
                localStorage.setItem('stickers', JSON.stringify(stickers));
                
                // 更新显示
                loadStickers();
                
                // 重置input，允许重复选择同一文件
                document.getElementById('sticker-upload').value = '';
                
                showToast('表情包已添加');
            };
            reader.readAsDataURL(file);
        }
        
        function loadStickers() {
            const stickerGrid = document.getElementById('sticker-grid');
            const stickers = JSON.parse(localStorage.getItem('stickers') || '[]');
            
            if (stickers.length === 0) {
                stickerGrid.innerHTML = `
                    <div class="text-center text-gray-medium text-sm py-8 col-span-4">
                        还没有表情包，点击"+"添加
                    </div>
                `;
                return;
            }
            
            stickerGrid.innerHTML = '';
            
            stickers.forEach(sticker => {
                const stickerElement = document.createElement('div');
                stickerElement.className = 'sticker-item aspect-square rounded-lg overflow-hidden cursor-pointer hover:opacity-90 transition-opacity relative group p-1';
                stickerElement.innerHTML = `
                    <img src="${sticker.url}" alt="表情包" class="w-full h-full object-cover rounded">
                    <button class="delete-sticker absolute top-1 right-1 bg-black/50 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" data-id="${sticker.id}">
                        <i class="fa fa-times text-xs"></i>
                    </button>
                `;
                
                // 点击表情包直接发送
                stickerElement.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-sticker')) {
                        sendSticker(sticker.url);
                    }
                });
                
                // 点击删除按钮
                stickerElement.querySelector('.delete-sticker').addEventListener('click', (e) => {
                    e.stopPropagation();
                    stickerToDelete = sticker.id;
                    document.getElementById('delete-confirm').classList.remove('hidden');
                });
                
                stickerGrid.appendChild(stickerElement);
            });
        }
        
        function sendSticker(url) {
            const chatMessages = document.getElementById('chat-messages');
            
            // 添加消息到聊天区域
            const messageElement = document.createElement('div');
            messageElement.className = 'flex justify-end animate-fadeIn';
            messageElement.innerHTML = `
                <div class="max-w-[80%]">
                    <div class="bg-primary/10 p-1 message-bubble-right inline-block">
                        <img src="${url}" alt="发送的表情包" class="w-24 h-24 object-cover rounded">
                    </div>
                    <div class="text-right text-xs text-gray-medium mt-1">
                        ${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>
            `;
            
            // 清空初始提示
            if (chatMessages.querySelector('.text-center')) {
                chatMessages.innerHTML = '';
            }
            
            chatMessages.appendChild(messageElement);
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function toggleStickers() {
            const stickerLibrary = document.getElementById('sticker-library');
            const toggleButton = document.getElementById('toggle-stickers');
            
            stickersVisible = !stickersVisible;
            
            if (stickersVisible) {
                // 显示表情包库，设置高度
                stickerLibrary.style.height = '200px';
                // 切换按钮高亮
                toggleButton.classList.add('sticker-active');
            } else {
                // 隐藏表情包库
                stickerLibrary.style.height = '0';
                // 取消按钮高亮
                toggleButton.classList.remove('sticker-active');
            }
        }
        
        function cancelDeleteSticker() {
            document.getElementById('delete-confirm').classList.add('hidden');
            stickerToDelete = null;
        }
        
        function confirmDeleteSticker() {
            if (stickerToDelete) {
                let stickers = JSON.parse(localStorage.getItem('stickers') || '[]');
                stickers = stickers.filter(sticker => sticker.id !== stickerToDelete);
                localStorage.setItem('stickers', JSON.stringify(stickers));
                loadStickers();
                showToast('表情包已删除');
            }
            
            document.getElementById('delete-confirm').classList.add('hidden');
            stickerToDelete = null;
        }
        
        function clearChat() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="text-center text-gray-medium text-sm py-4">
                    开始你的肯定语交流吧
                </div>
            `;
            showToast('聊天记录已清空');
        }
        
        // 3. 睡前肯定相关函数
        function addMoreItem() {
            const successItems = document.getElementById('success-items');
            const itemCount = successItems.querySelectorAll('.success-item').length;
            
            const newItem = document.createElement('div');
            newItem.className = 'success-item mb-3 flex gap-2';
            newItem.innerHTML = `
                <span class="bg-secondary rounded-full w-6 h-6 flex items-center justify-center text-gray-medium flex-shrink-0">${itemCount + 1}</span>
                <input type="text" class="flex-1 px-3 py-2 rounded-lg border border-gray-light focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none transition-all" placeholder="今天的第${itemCount + 1}件成功小事...">
            `;
            
            successItems.appendChild(newItem);
        }
        
        function saveDailyItems() {
            const inputs = document.querySelectorAll('#success-items input');
            const items = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(item => item !== '');
            
            if (items.length < 5) {
                showToast('请至少输入5件成功的小事');
                return;
            }
            
            const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const history = JSON.parse(localStorage.getItem('dailyAffirmations') || '{}');
            
            history[date] = {
                date: date,
                items: items,
                comment: null,
                timestamp: new Date().getTime()
            };
            
            localStorage.setItem('dailyAffirmations', JSON.stringify(history));
            
            showToast('今日小事已保存');
            
            // 刷新历史记录
            loadHistory();
        }
        
        async function generateDailyComment() {
            const inputs = document.querySelectorAll('#success-items input');
            const items = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(item => item !== '');
            
            if (items.length < 5) {
                showToast('请至少输入5件成功的小事');
                return;
            }
            
            // 显示加载状态
            const generateBtn = document.getElementById('generate-daily-comment');
            const originalText = generateBtn.innerHTML;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 生成中...';
            
            try {
                // 准备提示语，强调要针对具体内容给出真诚反馈
                const itemsText = items.map((item, index) => `${index + 1}. ${item}`).join('\n');
                const prompt = `用户今天完成了这些成功的小事：\n${itemsText}\n请根据这些具体内容，写一段4-5句话的鼓励和肯定。要真诚具体，结合用户提到的事情，不要泛泛而谈。语气温暖友好，让用户感受到被理解和肯定。`;
                
                // 模拟API调用 - 根据不同类型的输入生成更贴合的反馈
                setTimeout(() => {
                    // 分析用户输入的关键词，生成更相关的评论
                    let mockComment = "";
                    
                    // 检测学习相关内容
                    if (items.some(item => item.includes("学习") || item.includes("读书") || item.includes("写") || item.includes("作业"))) {
                        mockComment = "今天你在学习上取得了不少进步呢！坚持阅读和完成作业真的很不容易，为你的自律点赞。每一点积累都会带来大改变，继续保持这种状态，你会越来越优秀。为你今天的努力感到骄傲！";
                    } 
                    // 检测运动相关内容
                    else if (items.some(item => item.includes("运动") || item.includes("锻炼") || item.includes("跑步") || item.includes("健身"))) {
                        mockComment = "今天你坚持运动真的很棒！能够克服惰性动起来，这份毅力让人佩服。运动不仅能锻炼身体，还能带来好心情，看得出你很会照顾自己。继续保持这种健康的生活方式，你会收获更多能量！";
                    }
                    // 检测人际相关内容
                    else if (items.some(item => item.includes("朋友") || item.includes("家人") || item.includes("聊天") || item.includes("帮助") || item.includes("联系"))) {
                        mockComment = "今天你在人际交往上做得很好呀！主动联系朋友或帮助他人，这份温暖很珍贵。良好的人际关系能给我们带来很多快乐，你在这方面很有天赋呢。继续用心经营，你会收获更多爱与支持！";
                    }
                    // 通用情况
                    else {
                        mockComment = "今天你完成了这么多事情，真的很了不起！每一件小事都是进步的证明，值得被肯定。能感受到你对生活的用心，这种态度会带你走得更远。为今天的你鼓掌，期待明天更棒的表现！";
                    }
                    
                    // 显示评论
                    const commentContainer = document.getElementById('daily-comment');
                    const commentContent = document.getElementById('ai-comment-content');
                    commentContent.textContent = mockComment;
                    commentContainer.classList.remove('hidden');
                    
                    // 保存评论到本地存储
                    const date = new Date().toISOString().split('T')[0];
                    const history = JSON.parse(localStorage.getItem('dailyAffirmations') || '{}');
                    
                    if (history[date]) {
                        history[date].comment = mockComment;
                        localStorage.setItem('dailyAffirmations', JSON.stringify(history));
                    }
                    
                    // 恢复按钮状态
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = originalText;
                    
                    // 滚动到评论区域
                    commentContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 1000);
            } catch (error) {
                console.error('生成AI评论失败:', error);
                showToast('生成鼓励失败，请重试');
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            }
        }
        
        function loadHistory() {
            const historyList = document.getElementById('history-list');
            const history = JSON.parse(localStorage.getItem('dailyAffirmations') || '{}');
            
            // 转换为数组并按日期排序（最新的在前）
            const historyArray = Object.values(history).sort((a, b) => b.timestamp - a.timestamp);
            
            if (historyArray.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center text-gray-medium text-sm py-4">
                        暂无记录
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = '';
            
            historyArray.forEach(entry => {
                // 格式化日期显示
                const dateObj = new Date(entry.date);
                const formattedDate = dateObj.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', weekday: 'short' });
                
                const entryElement = document.createElement('div');
                entryElement.className = 'history-entry p-3 bg-secondary rounded-lg hover:bg-secondary/70 transition-colors cursor-pointer';
                entryElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-medium">${formattedDate}</h4>
                        <span class="text-xs text-gray-medium">${entry.items.length}件小事</span>
                    </div>
                    <div class="text-sm text-gray-dark line-clamp-2">
                        ${entry.items[0]}${entry.items.length > 1 ? ` 等${entry.items.length}件事` : ''}
                    </div>
                    ${entry.comment ? `
                        <div class="mt-2 text-xs text-primary">
                            <i class="fa fa-comment-o mr-1"></i> 有AI鼓励
                        </div>
                    ` : ''}
                `;
                
                // 点击查看详情
                entryElement.addEventListener('click', () => {
                    showHistoryDetail(entry);
                });
                
                historyList.appendChild(entryElement);
            });
        }
        
        function showHistoryDetail(entry) {
            // 创建详情模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
            
            // 格式化日期
            const dateObj = new Date(entry.date);
            const formattedDate = dateObj.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            
            // 构建项目列表
            const itemsList = entry.items.map((item, index) => `
                <div class="flex gap-2 mb-2">
                    <span class="bg-primary/10 text-primary rounded-full w-5 h-5 flex items-center justify-center text-xs flex-shrink-0 mt-0.5">${index + 1}</span>
                    <span class="text-gray-dark">${item}</span>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg w-full max-w-md max-h-[80vh] overflow-y-auto">
                    <div class="p-4 border-b border-gray-light/30 flex justify-between items-center">
                        <h3 class="font-semibold">${formattedDate}</h3>
                        <button class="close-detail text-gray-dark hover:text-primary transition-colors">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <h4 class="font-medium mb-3 text-gray-dark">成功的小事：</h4>
                        <div class="mb-4">
                            ${itemsList}
                        </div>
                        ${entry.comment ? `
                            <div class="bg-primary/5 p-3 rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fa fa-robot text-primary"></i>
                                    <span class="font-medium text-sm">AI的鼓励</span>
                                </div>
                                <p class="text-gray-dark text-sm">${entry.comment}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 关闭按钮事件
            modal.querySelector('.close-detail').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // 工具函数：显示提示消息
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 2000);
        }
    </script>
</body>
</html>
